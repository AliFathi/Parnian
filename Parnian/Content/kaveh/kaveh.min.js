(function(n,t,i){"use strict";function f(t){n.ajax(e({beforeSend:function(){},cache:!1,complete:function(){},contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:null,dataType:"json",error:function(n,t,i){console.error(i)},method:"POST",processData:!0,statusCode:{404:function(){alert("page not found")},500:function(){alert("internal server error")}},success:function(){},traditional:!1,url:r.server.exploreAction},t))}function l(n,t){var i=r.classes,e=document.createElement("div"),c=document.createElement("div"),s=document.createElement("div"),u=document.createElement("div"),a=document.createElement("span"),h,f;return e.classList.add(i.navPaneItem),c.classList.add(i.navPaneName),s.style.marginLeft=25+10*t+"px",u.classList.add(i.navPaneNameText),u.setAttribute(r.attrs.url,n.path),u.innerHTML=n.name,a.className=i.navPaneNameIcon+" glyphicon glyphicon-folder-close",e.appendChild(c),c.appendChild(s),s.appendChild(u),u.appendChild(a),n.list!=null&&(h=document.createElement("span"),f=document.createElement("div"),h.className=i.navPaneToggle+" glyphicon glyphicon-triangle-right",f.classList.add(i.navPaneDrawer),t==0?h.classList.add(i.navPaneRotate):f.classList.add(i.navPaneClose),s.appendChild(h),e.appendChild(f),o(n.list,-1,function(n){return n.name}),n.list.forEach(function(n){f.appendChild(l(n,t+1))})),e}function s(n,t){var i=document.createElement("li"),f=document.createElement("div"),e=document.createElement("span"),h=document.createElement("label"),u,c;return i.setAttribute(r.attrs.url,n.path),e.className="glyphicon glyphicon-chevron-right",e.style.paddingLeft=10*t+"px",h.innerHTML=n.name,f.appendChild(e),f.appendChild(h),i.appendChild(f),n.list.length!=0&&(i.classList.add("k-has-children"),u=document.createElement("ul"),c=t==1?"k-accordion k-accordion-open":"k-accordion",u.className=c,o(n.list,-1,function(n){return n.name}),n.list.forEach(function(n){u.appendChild(s(n,t+1))}),i.appendChild(u)),i}function a(n,t){var u=r.classes,y=r.attrs,s=n.name,a=n.path,v=document.createElement("li"),i=document.createElement("div"),h=document.createElement("div"),e,f,o;if(i.classList.add(u.file),i.setAttribute(y.fileId,t),i.parentElement,h.classList.add(u.fileIcon),n.isDirectory)i.classList.add("k-type-"+r.fileTypes.folder),n.type=r.fileTypes.folder;else if(r.fileTypes.hasOwnProperty(n.extension)){if(e=r.fileTypes[n.extension],i.classList.add("k-type-"+e),n.type=e,e=="image"){var c=document.createElement("div"),l=document.createElement("img"),p=n.extension==".ico"?a:r.server.thumbnailAction+"?path=~"+a;c.classList.add(u.imageContainer);l.src=p;l.alt=s;c.appendChild(l);h.appendChild(c);i.classList.add(u.imageFile)}}else i.classList.add("k-type-other"),n.type="other";return f=document.createElement("div"),f.title=s,f.classList.add(u.fileName),f.innerHTML=s,o=document.createElement("input"),o.setAttribute("type","checkbox"),o.classList.add(u.selectInput),i.appendChild(h),i.appendChild(f),i.appendChild(o),v.appendChild(i),v}function e(n,t){if(typeof t=="object")for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);return n}function o(n,t,i){n.sort(function(n,r){var u=i(n),f=i(r);return typeof u=="boolean"?u&&!f?-t:!u&&f?t:0:typeof u=="number"||typeof u=="string"?u>f?-t:u<f?t:0:void 0})}var h;if(typeof n=="undefined")throw new Error("Kaveh File Manager requires jQuery");if(typeof t=="undefined")throw new Error("Kaveh File Manager requires BootBox");if(typeof i=="undefined")throw new Error("Kaveh File Manager requires Dropzone");var u=this,c=u.KavehFileManager,r=function(n){return this.options=e(r.defaults,n),this.bootstraped=!1,this.location={index:-1,current:this.options.home,parent:"",back:"",forth:""},this.dom={},this.dropzone={},this.history=[],this.id=h(),this.navPaneContent={},this.text=r.dictionary[this.options.lang],this.viewBoxContent=[],this.options.auto&&this.bootstrap(),r.instances[this.id]=this,this};r.prototype.addNewItem=function(n,i){var u=this;f({data:{type:n,name:i,parent:u.location.current},method:"POST",url:r.server.addNewItemAction,success:function(i){i.status==0?(u.refreshViewBox(),n==r.fileTypes.folder&&u.updateNavPane()):(i.status==1||i.status==2)&&t.alert(i.message)}})};r.prototype.bootstrap=function(){var n=this;n.initializeDOM();n.dom.hasOwnProperty("navPane")&&n.updateNavPane();n.dom.hasOwnProperty("viewBox")&&n.updateViewBox(n.location.current,"");n.initializeEvents();n.bootstraped=!0};r.prototype.close=function(){this.dom.body.style.display="none"};r.prototype.createNavPane=function(n){if(this.dom.hasOwnProperty("navPane")){var t=document.createElement("ul");t.className="k-accordion k-accordion-open";t.appendChild(s(n,1));this.dom.navPane.appendChild(t)}};r.prototype.createViewBox=function(n,t){var f=this,i=f.dom,u=f.viewBoxContent;if(i.hasOwnProperty("viewBox")){if(i.hasOwnProperty("statusBar")&&(i.status.innerHTML=u.length+" مورد"),u.length==0){i.boxMessage.innerHTML=r.dictionary[f.options.lang].emptyFolderInfo;i.boxMessage.style.display="block";return}i.boxMessage.style.display="none";r.kfsi.hasOwnProperty(n)||(n=r.kfsi.isDirectory);t!=1&&t!=-1&&(t=1);o(u,t,function(t){return t[n]});u.forEach(function(n,t){n.isSelected=!1;n.type="";i.viewBox.appendChild(a(n,t))})}};r.prototype.kfsiProperty=function(n,t,i){var f=this,u;if(r.kfsi.hasOwnProperty(t)){if(u=f.viewBoxContent[n],typeof i!="undefined"){u[t]=i;return}return u[t]}};r.prototype.getNavPaneContent=function(n){var u=this,i=e({deepDive:!0,path:"~/",success:function(n){n.status==0?(u.navPaneContent=n.data,u.createNavPane(n.data)):n.status==1&&t.alert(n.message)}},n);f({method:"GET",url:r.server.getNavPaneContentAction,data:{path:i.path,exclude:i.exclude,deepDive:i.deepDive},success:i.success})};r.prototype.getViewBoxContent=function(n){var i=this,u=e({exclude:"",path:i.location.current,success:function(n){n.status==0?(i.viewBoxContent=n.data.list,i.updateAddressBar(),i.createViewBox()):(t.alert(n.message),i.updateViewBox("/"))}},n);f({method:"GET",url:r.server.getViewBoxContentAction,data:{path:u.path,exclude:u.exclude},success:u.success})};r.prototype.initializeDOM=function(){var n=this,f,s,h,e,c,o,l;if(n.options.scaffoldBody){n.dom=n.scafold();return}if(n.dom.body=document.getElementById(n.options.id),!n.dom.body){alert("پنل مدیریت فایل یافت نشد!");return}var u=n.dom.body,t=r.classes,a=u.querySelectorAll("."+t.toolBar)[0];a&&(n.dom.toolBar=a);f=u.querySelectorAll("."+t.addressBar)[0];f&&(n.dom.addressBar=f,n.dom.historyBackBtn=f.querySelectorAll("."+t.historyBackBtn)[0],n.dom.historyForwardBtn=f.querySelectorAll("."+t.historyForwardBtn)[0],n.dom.parentDirBtn=f.querySelectorAll("."+t.parentDirBtn)[0],n.dom.breadcrumb=f.querySelectorAll("."+t.breadcrumb)[0]);s=u.querySelectorAll("."+t.navPane)[0];s&&(n.dom.navPane=s);h=u.querySelectorAll("."+t.viewBox)[0];h&&(n.dom.viewBox=h,n.dom.boxMessage=u.querySelectorAll("."+t.boxMessage)[0]);e=u.querySelectorAll("."+t.statusBar)[0];e&&(n.dom.statusBar=e,n.dom.status=e.querySelectorAll("."+t.status)[0]);c=u.querySelectorAll("."+t.chooseBar)[0];c&&(n.dom.chooseBar=c);o=u.querySelectorAll("."+t.uploadSection)[0];o&&(n.dom.uploadSection=o,n.dom.uploadForm=o.querySelectorAll("."+t.uploadForm)[0],i.autoDiscover=!1,n.dropzone=new i(n.dom.uploadForm,{url:r.server.uploadAction+"?parent="+n.location.current,uploadMultiple:!0,autoProcessQueue:!1,parallelUploads:4,maxFilesize:20,addRemoveLinks:!0,init:function(){},dictDefaultMessage:"فایلا رو بندازید اینجا",dictFallbackMessage:"مرورگر شما از قابلیت بگیر و بنداز پشتیبانی نمی‌کند.",dictFallbackText:"Please use the fallback form below to upload your files like in the olden days.",dictFileTooBig:"فایل خیلی بزرگه ({{filesize}}MiB). حداکثر حجم مجاز: {{maxFilesize}}MiB است.",dictInvalidFileType:"You can't upload files of this type.",dictResponseError:"پاسخ سرور:‌ کد {{statusCode}}.",dictCancelUpload:"لغو بارگذاری",dictCancelUploadConfirmation:"توقف بارگذاری؟",dictRemoveFile:"حذف فایل از لیست",dictRemoveFileConfirmation:"فایل از لیست حذف شود؟",dictMaxFilesExceeded:"نمی‌توانید بیشتر از این بارگذاری کنید."}));typeof n.options.modalId=="string"&&(l=document.getElementById(n.options.modalId),l!=null&&(n.dom.modal=l))};r.prototype.initializeEvents=function(){var i=this,h=i.dom,s=n(h.toolBar),c=n(h.addressBar),v=n(h.navPane),l=n(h.viewBox),b=n(h.statusBar),y=n(h.chooseBar),p=n(h.uploadSection),a=i.options,e=r.classes,w=r.attrs,o=r.dictionary[a.lang];if(s){s.on("click","."+e.removeBtn,function(){var n=i.viewBoxContent.filter(function(n){return n[r.kfsi.isSelected]}),u=n.length,e,s;if(u==0){t.alert(o.nothingSelected);return}for(var h=0,c=0,l=o.removeConfirm,a=new FormData;u--;)e=n[u],s="",e.isDirectory?(c++,s="folder"):(h++,s="file"),n[u]={id:e.id,type:s,url:e.path};h!=0&&(l+="<br/>"+h+" "+o.file);c!=0&&(l+="<br/>"+c+" "+o.folder);a.append("json",JSON.stringify(n));t.confirm(l,function(n){n&&f({dataType:"json",url:r.server.removeAction,data:a,contentType:!1,processData:!1,success:function(){i.refreshViewBox()}})})});s.on("click","."+e.renameBtn,function(){var n=i.viewBoxContent.filter(function(n){return n[r.kfsi.isSelected]}),u=n.length;if(u==0){t.alert(o.nothingSelected);return}t.prompt({title:"تغییر نام",value:"new name",callback:function(e){var s,h;if(e!==null){for(var c=0,l=0,a=o.renameConfirm,v=new FormData;u--;)s=n[u],h="",s.isDirectory?(l++,h="folder"):(c++,h="file"),n[u]={id:s.id,type:h,url:s.path};c!=0&&(a+="<br/>"+c+" "+o.file);l!=0&&(a+="<br/>"+l+" "+o.folder);v.append("newName",e);v.append("json",JSON.stringify(n));t.confirm(a,function(n){n&&f({dataType:"json",url:r.server.renameAction,data:v,contentType:!1,processData:!1,success:function(){i.refreshViewBox()}})})}}})});s.on("click","."+e.uploadBtn,function(){h.uploadSection.style.display="block";i.dropzone.options.url=r.server.uploadAction+"?parent="+i.location.current});s.on("click","."+e.linkBtn,function(){var n=i.viewBoxContent.filter(function(n){return n[r.kfsi.isSelected]}),u=n.length;if(u==0){t.alert(o.nothingSelected);return}prompt(o.copyUrlPrompt+"  Ctrl + C, Enter",n[0].path)});s.on("click","."+e.downloadBtn,function(){var n=i.viewBoxContent.filter(function(n){return n[r.kfsi.isSelected]}),u=n.length;if(u==0){t.alert(o.nothingSelected);return}t.prompt({title:o.enterDownloadFileName,value:"download",callback:function(t){while(u--){var i=n[u],f="";f=i.isDirectory?"folder":"file";n[u]={id:i.name,type:f,url:i.path};window.location=r.server.downloadAction+"?json="+JSON.stringify(n)+"&downloadName="+t}}})});s.on("click","."+e.downloadLinkBtn,function(){var n=i.viewBoxContent.filter(function(n){return n[r.kfsi.isSelected]}),f=n.length;if(f==0){t.alert(o.nothingSelected);return}prompt(o.copyUrlPrompt+"  Ctrl + C, Enter",u.location.protocol+"//"+u.location.hostname+n[0].path)});s.on("click","."+e.invertSelectionBtn,function(){l.find("."+e.selectInput).click()});s.on("click","."+e.deselectAllBtn,function(){l.find("."+e.selectInput+":checked").click()});s.on("click","."+e.selectAllBtn,function(){l.find("."+e.selectInput).not(":checked").click()});s.on("click","."+e.addFileBtn,function(){t.prompt({title:o.enterNewFileName,value:"New File.txt",callback:function(n){n&&i.addNewItem(r.fileTypes.file,n)}})});s.on("click","."+e.addFolderBtn,function(){t.prompt({title:o.enterNewFolderName,value:"New Folder",callback:function(n){n&&i.addNewItem(r.fileTypes.folder,n)}})})}if(c){c.on("click","."+e.historyForwardBtn,function(){i.updateViewBox(i.location.forth,"forward")});c.on("click","."+e.historyBackBtn,function(){i.updateViewBox(i.location.back,"back")});c.on("click","."+e.parentDirBtn,function(){i.updateViewBox(i.location.parent)});c.on("click","."+e.refreshBtn,function(){i.refreshViewBox()});c.on("click","."+e.goBtn,function(){i.updateViewBox(i.dom.breadcrumb.value)});c.on("click","."+e.homeBtn,function(){i.updateViewBox(a.home)})}if(v){v.on("click","."+e.navPaneNameText,function(){i.updateViewBox(n(this).attr(w.url))});v.on("click","."+e.navPaneToggle,function(){n(this.parentElement.parentElement.nextElementSibling).toggleClass(e.navPaneClose);n(this).toggleClass(e.navPaneRotate)})}if(l){l.on("dblclick",".k-type-"+r.fileTypes.folder,function(){i.updateViewBox(i.kfsiProperty(parseInt(this.getAttribute(w.fileId)),r.kfsi.path))});l.on("change","."+e.selectInput,function(){var t=this.parentElement,u=parseInt(t.getAttribute(w.fileId));n(this).prop("checked")?(t.classList.add(e.selected),i.kfsiProperty(u,r.kfsi.isSelected,!0)):(t.classList.remove(e.selected),i.kfsiProperty(u,r.kfsi.isSelected,!1))})}if(b,y){y.on("click","."+e.chooseBtn,function(){var n=i.viewBoxContent.filter(function(n){return n[r.kfsi.isSelected]});n.length!=0&&a.onchoose.call(i,n)});y.on("click","."+e.cancelBtn,function(){a.oncancel.call(i)})}if(p){p.on("click",".k-upload-cancel",function(){h.uploadSection.style.display="none";i.dropzone.removeAllFiles()});p.on("click",".k-upload-submit",function(){i.dropzone.processQueue()})}};r.prototype.refreshViewBox=function(){var n=this;if(n.dom.hasOwnProperty("viewBox")){for(n.viewBoxContent=[];n.dom.viewBox.firstChild;)n.dom.viewBox.removeChild(n.dom.viewBox.firstChild);this.getViewBoxContent()}};r.prototype.scafold=function(){};r.prototype.updateAddressBar=function(){var n=this,t=n.dom,i=n.location.current,r;if(t.addressBar){if(r=i.slice(0,i.lastIndexOf("/")),n.location.parent=r==""?"/":r,t.breadcrumb.value=i,i!=n.history[n.location.index]){if(n.location.index<n.history.length-1)while(n.history.length>n.location.index+1)n.history.pop();n.history.push(i);n.location.index++}n.location.parent==i?t.parentDirBtn.setAttribute("disabled","disabled"):t.parentDirBtn.removeAttribute("disabled");n.location.index==0?t.historyBackBtn.setAttribute("disabled","disabled"):n.history[n.location.index-1]&&(t.historyBackBtn.removeAttribute("disabled"),n.location.back=n.history[n.location.index-1]);n.location.index==n.history.length-1?t.historyForwardBtn.setAttribute("disabled","disabled"):n.history[n.location.index+1]&&(t.historyForwardBtn.removeAttribute("disabled"),n.location.forth=n.history[n.location.index+1])}};r.prototype.updateNavPane=function(){var n=this;if(n.dom.navPane){while(n.dom.navPane.firstChild)n.dom.navPane.removeChild(n.dom.navPane.firstChild);n.getNavPaneContent()}};r.prototype.updateViewBox=function(n,t){var i=this;i.dom.hasOwnProperty("viewBox")&&(n!="/"&&n.lastIndexOf("/")==n.length-1&&(n=n.slice(0,n.length-1)),i.location.current=n,t=="back"&&i.location.index>0?i.location.index--:t=="forward"&&i.location.index<i.history.length-1&&i.location.index++,i.refreshViewBox())};h=function(){var n=0;return function(){return"kfm"+n++}}();r.defaults={auto:!0,closeAfterSelect:!0,downloadAction:"/Home/download?url=~",home:"/",id:"kaveh",lang:"fa",locationHistoryLength:20,multiChoose:!0,scaffoldBody:!1,selectFile:!1,modalId:"",onchoose:function(n){alert(n.length+" folder(s)")},oncancel:function(){},onstart:function(){},selsectRole:{include:[],exclude:[]},showRole:{include:[],exclude:[]},uploadRole:{include:[],exclude:[]}};r.server={controller:"/Kaveh/FileManager",addNewItemAction:"/Kaveh/FileManager/AddNewItem",downloadAction:"/Kaveh/FileManager/Download",getNavPaneContentAction:"/Kaveh/FileManager/GetNavPaneContent",getViewBoxContentAction:"/Kaveh/FileManager/GetViewBoxContent",removeAction:"/Kaveh/FileManager/Remove",renameAction:"/Kaveh/FileManager/Rename",thumbnailAction:"/Kaveh/FileManager/Thumbnail",uploadAction:"/Kaveh/FileManager/Upload"};r.kfsi={name:"name",extension:"extension",path:"path",creation:"creation",imageDimensions:"imageDimensions",length:"length",isDirectory:"isDirectory",isSelected:"isSelected",type:"type"};r.classes={pluginClass:"kaveh",toolBar:"k-tool-bar",addFileBtn:"k-add-file",addFolderBtn:"k-add-folder",removeBtn:"k-remove",renameBtn:"k-rename",copyBtn:"k-copy",cutBtn:"k-cut",sortByNameBtn:"k-sort-name",sortByTypeBtn:"k-sort-type",sortBySizeBtn:"k-sort-size",filterByNameBtn:"k-filter-name",filterByTypeBtn:"k-filter-type",filterBySizeBtn:"k-filter-size",uploadBtn:"k-upload",linkBtn:"k-link",downloadBtn:"k-download",downloadLinkBtn:"k-download-link",viewLargeTileBtn:"k-view-tile-large",viewSmallTileBtn:"k-view-tile-small",viewDetailsBtn:"k-view-details",selectAllBtn:"k-select-all",deselectAllBtn:"k-deselect-all",invertSelectionBtn:"k-invert-selection",addressBar:"k-address-bar",searchBtn:"k-search",searchInput:"k-search-input",refreshBtn:"k-refresh",goBtn:"k-go",breadcrumb:"k-breadcrumb",homeBtn:"k-home-directory",parentDirBtn:"k-parent-directory",historyBackBtn:"k-history-back",historyForwardBtn:"k-history-forward",content:"k-content-wrapper",viewBox:"k-viewbox",boxMessage:"k-viewbox-msg",file:"k-file",imageFile:"k-img-file",imageContainer:"k-img-ctr",fileName:"k-file-name",fileIcon:"k-file-icon",selectInput:"k-file-select",selected:"k-selected",navPane:"k-pane",navPaneItem:"k-pane-item",navPaneName:"k-pane-name",navPaneNameText:"k-pane-text",navPaneNameIcon:"k-pane-icon",navPaneToggle:"k-pane-toggle",navPaneRotate:"k-pane-rotate",navPaneDrawer:"k-pane-drawer",navPaneClose:"k-pane-close",statusBar:"k-status-bar",status:"k-status",chooseBar:"k-choose-bar",chooseBtn:"k-choose",cancelBtn:"k-cancel",uploadSection:"k-upload-section",uploadForm:"k-upload-form"};r.attrs={creation:"data-creation",dimensions:"data-dim",fileId:"data-k-id",lastAccess:"data-access",lastWrite:"data-write",length:"data-len",title:"title",type:"data-k-type",url:"data-url"};r.fileTypes={file:"file",folder:"folder",".apk":"program",".aspx":"aspx",".avi":"movie",".config":"config",".cs":"csharp",".cshtml":"cshtml",".css":"stylesheet",".dll":"dll",".exe":"program",".fon":"font",".gif":"image",".htm":"html",".html":"html",".ico":"image",".ini":"config",".jpg":"image",".jpeg":"image",".js":"javascript",".json":"json",".mp3":"sound",".mp4":"movie",".mkv":"movie",".mov":"movie",".otf":"font",".pdf":"pdf",".png":"image",".srt":"text",".ttc":"font",".ttf":"font",".txt":"text",".wma":"sound",".xml":"text"};r.instances={};r.dictionary={fa:{close:"بستن این پنجره",copyUrlLabel:"کپی آدرس",copyUrlPrompt:"این متن را کپی کنید",directoryNotExists:"این فولدر وجود ندارد",downloadLabel:"دانلود",emptyFolderInfo:"این پوشه خالیست",enterDownloadFileName:"فایل زیپ با چه نامی دریافت شود؟",enterNewFileName:"نام و پسوند فایل جدید را وارد کنید. مثلا new.txt",enterNewFolderName:"نام فولدر جدید را وارد کنید.",file:"فایل",fileRemoveConfirm:"این فایل حذف شود؟",folder:"فولدر",folderRemoveConfirm:"با حذف این پوشه، همه‌ی محتویات آن نیز حذف می‌شوند\nآیا مطمئن هستید؟",internalError:"خطای سرور",newName:"نام جدید",nothingSelected:"چیزی انتخاب نشده!",refresh:"بارگذاری دوباره",removeConfirm:"تایید حذف:",removeFailedError:"انجام نشد!",removeLabel:"حذف",renameConfirm:"تایید تغییر نام:",renameFailedError:"انجام نشد!",renameLabel:"تغییر نام",upload:"آپلود"}};u.KavehFileManager=r;r.noConflict=function(){return u.KavehFileManager=c,r}}).call(this,jQuery,bootbox,Dropzone);